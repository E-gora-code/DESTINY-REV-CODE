package org.firstinspires.ftc.teamcode.teamcode.openCV;

import com.acmerobotics.dashboard.FtcDashboard;
import com.qualcomm.robotcore.eventloop.opmode.Autonomous;
import com.qualcomm.robotcore.eventloop.opmode.LinearOpMode;

import org.firstinspires.ftc.robotcore.external.Telemetry;
import org.firstinspires.ftc.robotcore.external.hardware.camera.WebcamName;
import org.openftc.easyopencv.OpenCvCamera;
import org.openftc.easyopencv.OpenCvCameraFactory;
import org.openftc.easyopencv.OpenCvCameraRotation;

@Autonomous
public class opentest extends LinearOpMode {
    OpenCvCamera webcam;
    BallDetector ballDetector = new BallDetector();
    Telemetry dash = FtcDashboard.getInstance().getTelemetry();

    @Override
    public void runOpMode() throws InterruptedException {
        int cameraMonitorViewId = hardwareMap.appContext.getResources().getIdentifier("cameraMonitorViewId", "id", hardwareMap.appContext.getPackageName());
        webcam = OpenCvCameraFactory.getInstance().createWebcam(hardwareMap.get(WebcamName.class, "Webcam 1"), cameraMonitorViewId);

        webcam.setPipeline(ballDetector);

        webcam.openCameraDeviceAsync(new OpenCvCamera.AsyncCameraOpenListener() {
            @Override
            public void onOpened() {
                webcam.startStreaming(320, 240, OpenCvCameraRotation.UPRIGHT);
            }

            @Override
            public void onError(int errorCode) {
                dash.addData("Camera Error", errorCode);
                dash.update();
            }
        });

        FtcDashboard.getInstance().startCameraStream(webcam, 12);

        while (!opModeIsActive() && !isStopRequested()) {
            dash.addData("Ball Count", ballDetector.ballCount);
            dash.addData("Range1 Balls", getBallsInRange(1));
            dash.addData("Range2 Balls", getBallsInRange(2));

            for (int i = 0; i < Math.min(ballDetector.circles.size(), 3); i++) {
                BallDetector.Circle ball = ballDetector.circles.get(i);
                dash.addData("Ball " + (i+1),
                        String.format("(%.1f, %.1f) R:%d", ball.center.x, ball.center.y, ball.range));
            }

            dash.update();
            sleep(50);
        }

        waitForStart();
        webcam.stopStreaming();
    }

    private int getBallsInRange(int range) {
        int count = 0;
        for (BallDetector.Circle ball : ballDetector.circles) {
            if (ball.range == range) count++;
        }
        return count;
    }
}