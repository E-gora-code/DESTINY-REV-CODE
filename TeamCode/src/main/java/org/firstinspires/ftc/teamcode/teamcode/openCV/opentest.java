package org.firstinspires.ftc.teamcode.teamcode.openCV;

import com.acmerobotics.dashboard.FtcDashboard;
import com.qualcomm.robotcore.eventloop.opmode.Autonomous;
import com.qualcomm.robotcore.eventloop.opmode.LinearOpMode;

import org.firstinspires.ftc.robotcore.external.Telemetry;
import org.firstinspires.ftc.robotcore.external.hardware.camera.WebcamName;
import org.openftc.easyopencv.OpenCvCamera;
import org.openftc.easyopencv.OpenCvCameraFactory;
import org.openftc.easyopencv.OpenCvCameraRotation;

@Autonomous
public class opentest extends LinearOpMode {
    OpenCvCamera webcam;
    BallDetector ballDetector = new BallDetector();
    Telemetry dash = FtcDashboard.getInstance().getTelemetry();

    @Override
    public void runOpMode() throws InterruptedException {
        int cameraMonitorViewId = hardwareMap.appContext.getResources().getIdentifier("cameraMonitorViewId", "id", hardwareMap.appContext.getPackageName());
        webcam = OpenCvCameraFactory.getInstance().createWebcam(hardwareMap.get(WebcamName.class, "Webcam 1"), cameraMonitorViewId);

        webcam.setPipeline(ballDetector);

        webcam.openCameraDeviceAsync(new OpenCvCamera.AsyncCameraOpenListener() {
            @Override
            public void onOpened() {
                webcam.startStreaming(320, 240, OpenCvCameraRotation.UPRIGHT);
            }

            @Override
            public void onError(int errorCode) {
                dash.addData("Camera Error", errorCode);
                dash.update();
            }
        });

        FtcDashboard.getInstance().startCameraStream(webcam, 24);

        while (!opModeIsActive() && !isStopRequested()) {
            // Выводим информацию о шарах в телеметрию
            dash.addData("Ball Count", ballDetector.ballCount);
            dash.addData("Has Three Balls", ballDetector.hasThreeBalls);

            if (ballDetector.ballCount >= 1) {
                dash.addData("Ball 1", String.format("(%.1f, %.1f)", ballDetector.ball1.x, ballDetector.ball1.y));
                dash.addData("Ball 1 Color", ballDetector.color1);
            }

            if (ballDetector.ballCount >= 2) {
                dash.addData("Ball 2", String.format("(%.1f, %.1f)", ballDetector.ball2.x, ballDetector.ball2.y));
                dash.addData("Ball 2 Color", ballDetector.color2);
            }

            if (ballDetector.ballCount >= 3) {
                dash.addData("Ball 3", String.format("(%.1f, %.1f)", ballDetector.ball3.x, ballDetector.ball3.y));
                dash.addData("Ball 3 Color", ballDetector.color1);

                // Добавляем информацию о дистанциях
                dash.addData("Distance 1-2", String.format("%.1f", ballDetector.distance12));
                dash.addData("Distance 2-3", String.format("%.1f", ballDetector.distance23));
                dash.addData("Distance 1-3", String.format("%.1f", ballDetector.distance13));
            }

            dash.update();
            sleep(50);
        }

        waitForStart();

        webcam.stopStreaming();
    }

    private String getColorTypeString(int colorType) {
        switch(colorType) {
            case 1: return "Color1 (Green)";
            case 2: return "Color2 (Blue)";
            default: return "Unknown";
        }
    }
}